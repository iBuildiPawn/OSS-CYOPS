package services

import (
	"fmt"
	"strings"
	"time"

	"github.com/google/uuid"
	"gorm.io/gorm"
)

// VulnerabilitySearchService handles advanced search and filtering
type VulnerabilitySearchService struct {
	db *gorm.DB
}

// NewVulnerabilitySearchService creates a new search service instance
func NewVulnerabilitySearchService(db *gorm.DB) *VulnerabilitySearchService {
	return &VulnerabilitySearchService{db: db}
}

// SearchParams contains all possible search and filter parameters
type SearchParams struct {
	// Full-text search
	Query string `json:"query"`

	// Basic filters (already implemented in Phase 3)
	Severity []string `json:"severity"`
	Status   []string `json:"status"`

	// Advanced filters (Phase 4)
	AssignedTo *uuid.UUID `json:"assigned_to"`
	CreatedBy  *uuid.UUID `json:"created_by"`

	// Date range filters
	DiscoveredFrom *time.Time `json:"discovered_from"`
	DiscoveredTo   *time.Time `json:"discovered_to"`
	CreatedFrom    *time.Time `json:"created_from"`
	CreatedTo      *time.Time `json:"created_to"`

	// CVSS range
	CVSSMin *float64 `json:"cvss_min"`
	CVSSMax *float64 `json:"cvss_max"`

	// Pagination
	Page  int `json:"page"`
	Limit int `json:"limit"`
}

// BuildSearchQuery constructs a GORM query with all applicable filters
func (s *VulnerabilitySearchService) BuildSearchQuery(params SearchParams) *gorm.DB {
	query := s.db.Model(&struct{}{})

	// Full-text search on title and description (PostgreSQL specific)
	if params.Query != "" {
		searchTerm := "%" + strings.ToLower(params.Query) + "%"
		query = query.Where(
			"LOWER(title) LIKE ? OR LOWER(description) LIKE ? OR cve_id ILIKE ?",
			searchTerm, searchTerm, searchTerm,
		)
	}

	// Severity filter (multi-select)
	if len(params.Severity) > 0 {
		query = query.Where("severity IN ?", params.Severity)
	}

	// Status filter (multi-select)
	if len(params.Status) > 0 {
		query = query.Where("status IN ?", params.Status)
	}

	// Assigned user filter
	if params.AssignedTo != nil {
		query = query.Where("assigned_to = ?", params.AssignedTo)
	}

	// Creator filter
	if params.CreatedBy != nil {
		query = query.Where("created_by = ?", params.CreatedBy)
	}

	// Discovery date range
	if params.DiscoveredFrom != nil {
		query = query.Where("discovered_at >= ?", params.DiscoveredFrom)
	}
	if params.DiscoveredTo != nil {
		// Add 1 day to include the entire end date
		endDate := params.DiscoveredTo.Add(24 * time.Hour)
		query = query.Where("discovered_at < ?", endDate)
	}

	// Creation date range
	if params.CreatedFrom != nil {
		query = query.Where("created_at >= ?", params.CreatedFrom)
	}
	if params.CreatedTo != nil {
		endDate := params.CreatedTo.Add(24 * time.Hour)
		query = query.Where("created_at < ?", endDate)
	}

	// CVSS score range
	if params.CVSSMin != nil {
		query = query.Where("cvss_score >= ?", params.CVSSMin)
	}
	if params.CVSSMax != nil {
		query = query.Where("cvss_score <= ?", params.CVSSMax)
	}

	// Soft delete filter (exclude deleted records)
	query = query.Where("deleted_at IS NULL")

	return query
}

// BuildSearchQueryWithFullText uses PostgreSQL full-text search (ts_vector)
// This is more efficient for large datasets
func (s *VulnerabilitySearchService) BuildSearchQueryWithFullText(params SearchParams) *gorm.DB {
	query := s.db.Model(&struct{}{})

	// PostgreSQL full-text search with ranking
	if params.Query != "" {
		// Create a ts_query from the search term
		searchQuery := strings.ReplaceAll(params.Query, " ", " & ")
		query = query.Where(
			`to_tsvector('english', COALESCE(title, '') || ' ' || COALESCE(description, '') || ' ' || COALESCE(cve_id, '')) @@ to_tsquery('english', ?)`,
			searchQuery,
		)
	}

	// Apply all other filters
	query = s.applyFilters(query, params)

	return query
}

// applyFilters is a helper to apply non-search filters
func (s *VulnerabilitySearchService) applyFilters(query *gorm.DB, params SearchParams) *gorm.DB {
	if len(params.Severity) > 0 {
		query = query.Where("severity IN ?", params.Severity)
	}

	if len(params.Status) > 0 {
		query = query.Where("status IN ?", params.Status)
	}

	if params.AssignedTo != nil {
		query = query.Where("assigned_to = ?", params.AssignedTo)
	}

	if params.CreatedBy != nil {
		query = query.Where("created_by = ?", params.CreatedBy)
	}

	if params.DiscoveredFrom != nil {
		query = query.Where("discovered_at >= ?", params.DiscoveredFrom)
	}

	if params.DiscoveredTo != nil {
		endDate := params.DiscoveredTo.Add(24 * time.Hour)
		query = query.Where("discovered_at < ?", endDate)
	}

	if params.CreatedFrom != nil {
		query = query.Where("created_at >= ?", params.CreatedFrom)
	}

	if params.CreatedTo != nil {
		endDate := params.CreatedTo.Add(24 * time.Hour)
		query = query.Where("created_at < ?", endDate)
	}

	if params.CVSSMin != nil {
		query = query.Where("cvss_score >= ?", params.CVSSMin)
	}

	if params.CVSSMax != nil {
		query = query.Where("cvss_score <= ?", params.CVSSMax)
	}

	query = query.Where("deleted_at IS NULL")

	return query
}

// GetSearchSuggestions returns search suggestions based on partial input
func (s *VulnerabilitySearchService) GetSearchSuggestions(partial string, limit int) ([]string, error) {
	if limit == 0 {
		limit = 10
	}

	var suggestions []string
	searchTerm := partial + "%"

	// Get CVE IDs matching the pattern
	err := s.db.Raw(`
		SELECT DISTINCT cve_id
		FROM vulnerabilities
		WHERE cve_id ILIKE ? AND deleted_at IS NULL
		ORDER BY cve_id
		LIMIT ?
	`, searchTerm, limit).Scan(&suggestions).Error

	if err != nil {
		return nil, fmt.Errorf("failed to get search suggestions: %w", err)
	}

	return suggestions, nil
}
