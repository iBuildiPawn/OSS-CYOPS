package models

import (
	"time"

	"github.com/google/uuid"
)

// VulnerabilitySeverity represents the severity level of a vulnerability
type VulnerabilitySeverity string

const (
	SeverityCritical VulnerabilitySeverity = "CRITICAL"
	SeverityHigh     VulnerabilitySeverity = "HIGH"
	SeverityMedium   VulnerabilitySeverity = "MEDIUM"
	SeverityLow      VulnerabilitySeverity = "LOW"
	SeverityNone     VulnerabilitySeverity = "NONE"
)

// VulnerabilityStatus represents the lifecycle status of a vulnerability
type VulnerabilityStatus string

const (
	StatusOpen          VulnerabilityStatus = "OPEN"
	StatusInProgress    VulnerabilityStatus = "IN_PROGRESS"
	StatusResolved      VulnerabilityStatus = "RESOLVED"
	StatusVerified      VulnerabilityStatus = "VERIFIED"
	StatusClosed        VulnerabilityStatus = "CLOSED"
	StatusFalsePositive VulnerabilityStatus = "FALSE_POSITIVE"
)

// Vulnerability represents a security vulnerability record
type Vulnerability struct {
	BaseModel
	Title                     string                       `gorm:"type:varchar(255);not null" json:"title"`
	Description               string                       `gorm:"type:text;not null" json:"description"`
	Severity                  VulnerabilitySeverity        `gorm:"type:varchar(20);not null" json:"severity"`
	CVSSScore                 *float64                     `gorm:"type:decimal(3,1)" json:"cvss_score,omitempty"`
	CVSSVector                string                       `gorm:"type:varchar(100)" json:"cvss_vector,omitempty"`
	CVEID                     string                       `gorm:"type:varchar(20)" json:"cve_id,omitempty"`
	Status                    VulnerabilityStatus          `gorm:"type:varchar(20);not null;default:OPEN" json:"status"`
	Source                    string                       `gorm:"type:varchar(100);not null;default:'Manual';index" json:"source"`
	DiscoveryDate             time.Time                    `gorm:"type:date;not null" json:"discovery_date"`
	RemediationNotes          string                       `gorm:"type:text" json:"remediation_notes,omitempty"`
	ImpactAssessment          string                       `gorm:"type:text" json:"impact_assessment,omitempty"`
	StepsToReproduce          string                       `gorm:"type:text" json:"steps_to_reproduce,omitempty"`
	MitigationRecommendations string                       `gorm:"type:text" json:"mitigation_recommendations,omitempty"`
	CreatedByID               uuid.UUID                    `gorm:"type:uuid;not null" json:"created_by_id"`
	CreatedBy                 *User                        `gorm:"foreignKey:CreatedByID;constraint:OnDelete:RESTRICT" json:"created_by,omitempty"`
	AssignedToID              *uuid.UUID                   `gorm:"type:uuid" json:"assigned_to_id,omitempty"`
	AssignedTo                *User                        `gorm:"foreignKey:AssignedToID;constraint:OnDelete:SET NULL" json:"assigned_to,omitempty"`
	AffectedSystems           []AffectedSystem             `gorm:"many2many:vulnerability_affected_systems" json:"affected_systems,omitempty"`
	StatusHistory             []VulnerabilityStatusHistory `gorm:"foreignKey:VulnerabilityID" json:"status_history,omitempty"`
}

// TableName specifies the table name for Vulnerability model
func (Vulnerability) TableName() string {
	return "vulnerabilities"
}

// VulnerabilityStatusHistory tracks all status changes for audit purposes
type VulnerabilityStatusHistory struct {
	ID              uuid.UUID           `gorm:"type:uuid;primaryKey;default:uuid_generate_v4()" json:"id"`
	VulnerabilityID uuid.UUID           `gorm:"type:uuid;not null;index:idx_vsh_vulnerability" json:"vulnerability_id"`
	OldStatus       VulnerabilityStatus `gorm:"type:varchar(20);not null" json:"old_status"`
	NewStatus       VulnerabilityStatus `gorm:"type:varchar(20);not null" json:"new_status"`
	Notes           string              `gorm:"type:text" json:"notes,omitempty"`
	ChangedByID     uuid.UUID           `gorm:"type:uuid;not null" json:"changed_by_id"`
	ChangedBy       *User               `gorm:"foreignKey:ChangedByID;constraint:OnDelete:RESTRICT" json:"changed_by,omitempty"`
	ChangedAt       time.Time           `gorm:"not null;default:CURRENT_TIMESTAMP;index:idx_vsh_vulnerability" json:"changed_at"`
}

// TableName specifies the table name for VulnerabilityStatusHistory model
func (VulnerabilityStatusHistory) TableName() string {
	return "vulnerability_status_history"
}
