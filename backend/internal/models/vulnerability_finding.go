package models

import (
	"time"

	"github.com/google/uuid"
)

// FindingStatus represents the remediation status of a specific finding
type FindingStatus string

const (
	FindingStatusOpen       FindingStatus = "OPEN"
	FindingStatusMitigated  FindingStatus = "MITIGATED"
	FindingStatusFixed      FindingStatus = "FIXED"
	FindingStatusVerified   FindingStatus = "VERIFIED"
	FindingStatusAccepted   FindingStatus = "ACCEPTED"      // Risk accepted
	FindingStatusException  FindingStatus = "EXCEPTION"     // Granted exception
)

// VulnerabilityFinding represents a specific instance of a vulnerability on a particular asset
// This allows tracking the same vulnerability across multiple systems individually
type VulnerabilityFinding struct {
	ID              uuid.UUID         `gorm:"type:uuid;primaryKey;default:uuid_generate_v4()" json:"id"`

	// Link to parent vulnerability definition
	VulnerabilityID uuid.UUID         `gorm:"type:uuid;not null;index:idx_finding_vulnerability" json:"vulnerability_id"`
	Vulnerability   *Vulnerability    `gorm:"foreignKey:VulnerabilityID;constraint:OnDelete:CASCADE" json:"vulnerability,omitempty"`

	// Link to affected system
	AffectedSystemID uuid.UUID        `gorm:"type:uuid;not null;index:idx_finding_system" json:"affected_system_id"`
	AffectedSystem   *AffectedSystem  `gorm:"foreignKey:AffectedSystemID;constraint:OnDelete:CASCADE" json:"affected_system,omitempty"`

	// Finding-specific details (from Nessus scan)
	Port            string            `gorm:"type:varchar(10)" json:"port,omitempty"`
	Protocol        string            `gorm:"type:varchar(10)" json:"protocol,omitempty"`
	ServiceName     string            `gorm:"type:varchar(100)" json:"service_name,omitempty"`

	// Scanner-specific data
	PluginID        string            `gorm:"type:varchar(50);index:idx_finding_plugin" json:"plugin_id,omitempty"`
	PluginOutput    string            `gorm:"type:text" json:"plugin_output,omitempty"`      // Specific scan output for this host
	ScannerName     string            `gorm:"type:varchar(50)" json:"scanner_name,omitempty"` // nessus, qualys, etc

	// Finding status (independent of parent vulnerability)
	Status          FindingStatus     `gorm:"type:varchar(20);not null;default:OPEN" json:"status"`

	// Discovery and resolution tracking
	FirstDetected   time.Time         `gorm:"not null;default:CURRENT_TIMESTAMP" json:"first_detected"`
	LastSeen        time.Time         `gorm:"not null;default:CURRENT_TIMESTAMP" json:"last_seen"`
	FixedAt         *time.Time        `gorm:"type:timestamp" json:"fixed_at,omitempty"`
	VerifiedAt      *time.Time        `gorm:"type:timestamp" json:"verified_at,omitempty"`

	// Remediation tracking
	FixedBy         *uuid.UUID        `gorm:"type:uuid" json:"fixed_by,omitempty"`
	FixedByUser     *User             `gorm:"foreignKey:FixedBy;constraint:OnDelete:SET NULL" json:"fixed_by_user,omitempty"`
	FixNotes        string            `gorm:"type:text" json:"fix_notes,omitempty"`

	// Risk acceptance
	RiskAcceptedBy  *uuid.UUID        `gorm:"type:uuid" json:"risk_accepted_by,omitempty"`
	RiskAcceptedAt  *time.Time        `gorm:"type:timestamp" json:"risk_accepted_at,omitempty"`
	AcceptanceReason string           `gorm:"type:text" json:"acceptance_reason,omitempty"`
	ExpiresAt       *time.Time        `gorm:"type:timestamp" json:"expires_at,omitempty"`    // Risk acceptance expiry

	// Metadata
	CreatedBy       uuid.UUID         `gorm:"type:uuid;not null" json:"created_by"`
	CreatedByUser   *User             `gorm:"foreignKey:CreatedBy;constraint:OnDelete:RESTRICT" json:"created_by_user,omitempty"`
	CreatedAt       time.Time         `gorm:"not null;default:CURRENT_TIMESTAMP" json:"created_at"`
	UpdatedAt       time.Time         `gorm:"not null;default:CURRENT_TIMESTAMP" json:"updated_at"`
}

// TableName specifies the table name
func (VulnerabilityFinding) TableName() string {
	return "vulnerability_findings"
}

// FindingStatusHistory tracks status changes for individual findings
type FindingStatusHistory struct {
	ID              uuid.UUID     `gorm:"type:uuid;primaryKey;default:uuid_generate_v4()" json:"id"`
	FindingID       uuid.UUID     `gorm:"type:uuid;not null;index:idx_fsh_finding" json:"finding_id"`
	Finding         *VulnerabilityFinding `gorm:"foreignKey:FindingID;constraint:OnDelete:CASCADE" json:"finding,omitempty"`
	OldStatus       FindingStatus `gorm:"type:varchar(20);not null" json:"old_status"`
	NewStatus       FindingStatus `gorm:"type:varchar(20);not null" json:"new_status"`
	Notes           string        `gorm:"type:text" json:"notes,omitempty"`
	ChangedByID     uuid.UUID     `gorm:"type:uuid;not null" json:"changed_by_id"`
	ChangedBy       *User         `gorm:"foreignKey:ChangedByID;constraint:OnDelete:RESTRICT" json:"changed_by,omitempty"`
	ChangedAt       time.Time     `gorm:"not null;default:CURRENT_TIMESTAMP" json:"changed_at"`
}

// TableName specifies the table name
func (FindingStatusHistory) TableName() string {
	return "finding_status_history"
}
