package handlers

import (
	"fmt"
	"io"

	"github.com/gofiber/fiber/v2"
	"github.com/google/uuid"
	"github.com/cyops/cyops-backend/internal/services"
	"github.com/cyops/cyops-backend/pkg/utils"
)

// VulnerabilityImportHandler handles vulnerability import requests
type VulnerabilityImportHandler struct {
	parserService *services.NessusParserService
	importService *services.VulnerabilityImportService
}

// NewVulnerabilityImportHandler creates a new vulnerability import handler
func NewVulnerabilityImportHandler() *VulnerabilityImportHandler {
	return &VulnerabilityImportHandler{
		parserService: services.NewNessusParserService(),
		importService: services.NewVulnerabilityImportService(),
	}
}

// ImportNessusRequest represents import options
type ImportNessusRequest struct {
	SkipDuplicates bool `json:"skip_duplicates"`
}

// UploadNessusFile handles Nessus file upload and import
func (h *VulnerabilityImportHandler) UploadNessusFile(c *fiber.Ctx) error {
	userID := c.Locals("user_id").(uuid.UUID)

	// Parse multipart form
	file, err := c.FormFile("file")
	if err != nil {
		utils.Logger.Error().Err(err).Msg("Failed to get uploaded file")
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "No file uploaded",
		})
	}

	// Validate file extension
	if !isValidNessusFile(file.Filename) {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "Invalid file type. Only .nessus files are supported",
		})
	}

	// Open uploaded file
	src, err := file.Open()
	if err != nil {
		utils.Logger.Error().Err(err).Msg("Failed to open uploaded file")
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "Failed to process uploaded file",
		})
	}
	defer src.Close()

	// Read file content
	fileData, err := io.ReadAll(src)
	if err != nil {
		utils.Logger.Error().Err(err).Msg("Failed to read uploaded file")
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "Failed to read uploaded file",
		})
	}

	// Validate file
	if err := h.importService.ValidateNessusFile(fileData, file.Filename); err != nil {
		utils.Logger.Warn().Err(err).Str("filename", file.Filename).Msg("Invalid Nessus file")
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": err.Error(),
		})
	}

	// Parse Nessus file
	vulnerabilities, err := h.parserService.ParseNessusFile(fileData)
	if err != nil {
		utils.Logger.Error().Err(err).Str("filename", file.Filename).Msg("Failed to parse Nessus file")
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": fmt.Sprintf("Failed to parse Nessus file: %v", err),
		})
	}

	if len(vulnerabilities) == 0 {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "No vulnerabilities found in the uploaded file",
		})
	}

	// Get import options
	skipDuplicates := c.FormValue("skip_duplicates") == "true"

	// Import vulnerabilities
	result, err := h.importService.ImportFromNessus(vulnerabilities, userID, skipDuplicates)
	if err != nil {
		utils.Logger.Error().Err(err).Msg("Failed to import vulnerabilities")
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "Failed to import vulnerabilities",
		})
	}

	utils.Logger.Info().
		Str("user_id", userID.String()).
		Str("filename", file.Filename).
		Int("imported", result.ImportedVulnerabilities).
		Int("skipped", result.SkippedVulnerabilities).
		Msg("Nessus file imported successfully")

	return c.Status(fiber.StatusOK).JSON(fiber.Map{
		"message": "Nessus file imported successfully",
		"result":  result,
	})
}

// PreviewNessusFile previews what will be imported without actually importing
func (h *VulnerabilityImportHandler) PreviewNessusFile(c *fiber.Ctx) error {
	// Parse multipart form
	file, err := c.FormFile("file")
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "No file uploaded",
		})
	}

	// Validate file extension
	if !isValidNessusFile(file.Filename) {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "Invalid file type. Only .nessus files are supported",
		})
	}

	// Open and read file
	src, err := file.Open()
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "Failed to process uploaded file",
		})
	}
	defer src.Close()

	fileData, err := io.ReadAll(src)
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "Failed to read uploaded file",
		})
	}

	// Validate file
	if err := h.importService.ValidateNessusFile(fileData, file.Filename); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": err.Error(),
		})
	}

	// Parse Nessus file
	vulnerabilities, err := h.parserService.ParseNessusFile(fileData)
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": fmt.Sprintf("Failed to parse Nessus file: %v", err),
		})
	}

	// Get summary
	summary := h.parserService.GetImportSummary(vulnerabilities)

	// Return preview with first few vulnerabilities
	previewVulns := vulnerabilities
	if len(previewVulns) > 10 {
		previewVulns = previewVulns[:10]
	}

	return c.JSON(fiber.Map{
		"summary":         summary,
		"preview":         previewVulns,
		"total_preview":   len(previewVulns),
	})
}

// isValidNessusFile checks if filename has valid extension
func isValidNessusFile(filename string) bool {
	return len(filename) > 7 && filename[len(filename)-7:] == ".nessus"
}
