openapi: 3.0.3
info:
  title: CYOPS Vulnerability Management API
  description: API endpoints for vulnerability tracking and management
  version: 1.0.0
  contact:
    name: CYOPS Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://api.cyops.com/api/v1
    description: Production

tags:
  - name: Vulnerabilities
    description: Vulnerability CRUD operations
  - name: Search
    description: Vulnerability search and filtering
  - name: Affected Systems
    description: System management

paths:
  /vulnerabilities:
    get:
      tags:
        - Vulnerabilities
      summary: List vulnerabilities with pagination and filtering
      description: Retrieve a paginated list of vulnerabilities with optional filters
      operationId: listVulnerabilities
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number (1-indexed)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: severity
          in: query
          description: Filter by severity levels (comma-separated)
          required: false
          schema:
            type: string
            example: "CRITICAL,HIGH"
        - name: status
          in: query
          description: Filter by status values (comma-separated)
          required: false
          schema:
            type: string
            example: "OPEN,IN_PROGRESS"
        - name: search
          in: query
          description: Full-text search in title and description
          required: false
          schema:
            type: string
        - name: assignedTo
          in: query
          description: Filter by assigned user ID
          required: false
          schema:
            type: string
            format: uuid
        - name: createdBy
          in: query
          description: Filter by creator user ID
          required: false
          schema:
            type: string
            format: uuid
        - name: discoveryDateFrom
          in: query
          description: Filter by discovery date (from)
          required: false
          schema:
            type: string
            format: date
        - name: discoveryDateTo
          in: query
          description: Filter by discovery date (to)
          required: false
          schema:
            type: string
            format: date
        - name: sortBy
          in: query
          description: Sort field
          required: false
          schema:
            type: string
            enum: [discovery_date, severity, created_at, updated_at]
            default: discovery_date
        - name: sortOrder
          in: query
          description: Sort order
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityListResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags:
        - Vulnerabilities
      summary: Create a new vulnerability
      description: Create a new vulnerability record
      operationId: createVulnerability
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateVulnerabilityRequest"
      responses:
        "201":
          description: Vulnerability created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityResponse"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /vulnerabilities/{id}:
    get:
      tags:
        - Vulnerabilities
      summary: Get vulnerability by ID
      description: Retrieve detailed information about a specific vulnerability
      operationId: getVulnerability
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityDetailResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      tags:
        - Vulnerabilities
      summary: Update vulnerability
      description: Update an existing vulnerability (full update)
      operationId: updateVulnerability
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateVulnerabilityRequest"
      responses:
        "200":
          description: Vulnerability updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityResponse"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - Vulnerabilities
      summary: Delete vulnerability (soft delete)
      description: Soft delete a vulnerability (admin only)
      operationId: deleteVulnerability
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Vulnerability deleted successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /vulnerabilities/{id}/status:
    patch:
      tags:
        - Vulnerabilities
      summary: Update vulnerability status
      description: Change the status of a vulnerability and record in history
      operationId: updateVulnerabilityStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateStatusRequest"
      responses:
        "200":
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityResponse"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /vulnerabilities/{id}/assign:
    patch:
      tags:
        - Vulnerabilities
      summary: Assign vulnerability to user
      description: Assign or reassign a vulnerability to an analyst
      operationId: assignVulnerability
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignVulnerabilityRequest"
      responses:
        "200":
          description: Vulnerability assigned successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityResponse"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /vulnerabilities/{id}/affected-systems:
    get:
      tags:
        - Affected Systems
      summary: Get affected systems for vulnerability
      description: Retrieve list of systems affected by a specific vulnerability
      operationId: getAffectedSystems
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/AffectedSystem"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    post:
      tags:
        - Affected Systems
      summary: Add affected systems to vulnerability
      description: Associate one or more systems with a vulnerability
      operationId: addAffectedSystems
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vulnerability UUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - system_ids
              properties:
                system_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Array of affected system IDs
      responses:
        "200":
          description: Systems added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityResponse"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /affected-systems:
    get:
      tags:
        - Affected Systems
      summary: List all affected systems
      description: Retrieve paginated list of systems in the organization
      operationId: listAffectedSystems
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: systemType
          in: query
          description: Filter by system type
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/AffectedSystem"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"

    post:
      tags:
        - Affected Systems
      summary: Create affected system
      description: Register a new system in the inventory
      operationId: createAffectedSystem
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAffectedSystemRequest"
      responses:
        "201":
          description: System created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/AffectedSystem"

  /vulnerabilities/stats:
    get:
      tags:
        - Vulnerabilities
      summary: Get vulnerability statistics
      description: Retrieve aggregate statistics for dashboard
      operationId: getVulnerabilityStats
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VulnerabilityStats"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Vulnerability:
      type: object
      required:
        - id
        - title
        - description
        - severity
        - status
        - discovery_date
        - created_by_id
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 255
        description:
          type: string
        severity:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW, NONE]
        cvss_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 10.0
          nullable: true
        cvss_vector:
          type: string
          maxLength: 100
          nullable: true
        cve_id:
          type: string
          pattern: "^CVE-[0-9]{4}-[0-9]{4,}$"
          nullable: true
        status:
          type: string
          enum: [OPEN, IN_PROGRESS, RESOLVED, VERIFIED, CLOSED, FALSE_POSITIVE]
        discovery_date:
          type: string
          format: date
        remediation_notes:
          type: string
          nullable: true
        impact_assessment:
          type: string
          nullable: true
        steps_to_reproduce:
          type: string
          nullable: true
        mitigation_recommendations:
          type: string
          nullable: true
        created_by_id:
          type: string
          format: uuid
        assigned_to_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateVulnerabilityRequest:
      type: object
      required:
        - title
        - description
        - severity
        - discovery_date
      properties:
        title:
          type: string
          maxLength: 255
        description:
          type: string
        severity:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW, NONE]
        cvss_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 10.0
        cvss_vector:
          type: string
          maxLength: 100
        cve_id:
          type: string
          pattern: "^CVE-[0-9]{4}-[0-9]{4,}$"
        discovery_date:
          type: string
          format: date
        impact_assessment:
          type: string
        steps_to_reproduce:
          type: string
        mitigation_recommendations:
          type: string
        assigned_to_id:
          type: string
          format: uuid
        affected_system_ids:
          type: array
          items:
            type: string
            format: uuid

    UpdateVulnerabilityRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 255
        description:
          type: string
        severity:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW, NONE]
        cvss_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 10.0
        cvss_vector:
          type: string
          maxLength: 100
        cve_id:
          type: string
          pattern: "^CVE-[0-9]{4}-[0-9]{4,}$"
        remediation_notes:
          type: string
        impact_assessment:
          type: string
        steps_to_reproduce:
          type: string
        mitigation_recommendations:
          type: string

    UpdateStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [OPEN, IN_PROGRESS, RESOLVED, VERIFIED, CLOSED, FALSE_POSITIVE]
        notes:
          type: string
          description: Reason for status change

    AssignVulnerabilityRequest:
      type: object
      required:
        - assigned_to_id
      properties:
        assigned_to_id:
          type: string
          format: uuid
          nullable: true
          description: User ID to assign to, or null to unassign

    AffectedSystem:
      type: object
      required:
        - id
        - system_type
      properties:
        id:
          type: string
          format: uuid
        hostname:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        asset_id:
          type: string
          nullable: true
        system_type:
          type: string
          enum:
            [
              SERVER,
              WORKSTATION,
              NETWORK_DEVICE,
              APPLICATION,
              CONTAINER,
              CLOUD_SERVICE,
              OTHER,
            ]
        description:
          type: string
          nullable: true
        environment:
          type: string
          enum: [PRODUCTION, STAGING, DEVELOPMENT, TEST]
          default: PRODUCTION
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateAffectedSystemRequest:
      type: object
      required:
        - system_type
      properties:
        hostname:
          type: string
        ip_address:
          type: string
        asset_id:
          type: string
        system_type:
          type: string
          enum:
            [
              SERVER,
              WORKSTATION,
              NETWORK_DEVICE,
              APPLICATION,
              CONTAINER,
              CLOUD_SERVICE,
              OTHER,
            ]
        description:
          type: string
        environment:
          type: string
          enum: [PRODUCTION, STAGING, DEVELOPMENT, TEST]
          default: PRODUCTION

    VulnerabilityResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/Vulnerability"

    VulnerabilityDetailResponse:
      type: object
      properties:
        data:
          allOf:
            - $ref: "#/components/schemas/Vulnerability"
            - type: object
              properties:
                created_by:
                  $ref: "#/components/schemas/User"
                assigned_to:
                  $ref: "#/components/schemas/User"
                affected_systems:
                  type: array
                  items:
                    $ref: "#/components/schemas/AffectedSystem"
                status_history:
                  type: array
                  items:
                    $ref: "#/components/schemas/StatusHistoryEntry"

    VulnerabilityListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Vulnerability"
        meta:
          $ref: "#/components/schemas/PaginationMeta"

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string

    StatusHistoryEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        old_status:
          type: string
        new_status:
          type: string
        notes:
          type: string
        changed_by:
          $ref: "#/components/schemas/User"
        changed_at:
          type: string
          format: date-time

    VulnerabilityStats:
      type: object
      properties:
        total_count:
          type: integer
        by_severity:
          type: object
          properties:
            critical:
              type: integer
            high:
              type: integer
            medium:
              type: integer
            low:
              type: integer
            none:
              type: integer
        by_status:
          type: object
          properties:
            open:
              type: integer
            in_progress:
              type: integer
            resolved:
              type: integer
            verified:
              type: integer
            closed:
              type: integer
            false_positive:
              type: integer
        recent_discoveries:
          type: integer
          description: Count of vulnerabilities discovered in last 30 days

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

  responses:
    BadRequestError:
      description: Bad request - validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    UnauthorizedError:
      description: Unauthorized - authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    ForbiddenError:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
