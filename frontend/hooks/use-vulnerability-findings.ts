import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { vulnerabilityFindingApi } from "@/lib/api";
import type {
  FindingListParams,
  FindingListResponse,
  MarkFindingFixedRequest,
  MarkFindingVerifiedRequest,
  AcceptRiskRequest,
  VulnerabilityFinding,
} from "@/types/vulnerability";

// Query key factory
export const vulnerabilityFindingKeys = {
  all: ["vulnerability-findings"] as const,
  lists: () => [...vulnerabilityFindingKeys.all, "list"] as const,
  list: (filters: FindingListParams) =>
    [...vulnerabilityFindingKeys.lists(), filters] as const,
  details: () => [...vulnerabilityFindingKeys.all, "detail"] as const,
  detail: (id: string) => [...vulnerabilityFindingKeys.details(), id] as const,
  byVulnerability: (vulnerabilityId: string) =>
    [
      ...vulnerabilityFindingKeys.all,
      "vulnerability",
      vulnerabilityId,
    ] as const,
  bySystem: (systemId: string) =>
    [...vulnerabilityFindingKeys.all, "system", systemId] as const,
};

// Hook to get all findings with filters
export function useVulnerabilityFindings(params?: FindingListParams) {
  return useQuery<FindingListResponse>({
    queryKey: vulnerabilityFindingKeys.list(params || {}),
    queryFn: () => vulnerabilityFindingApi.list(params),
  });
}

// Hook to get findings for a specific vulnerability
export function useVulnerabilityFindingsByVulnerability(
  vulnerabilityId: string,
  params?: FindingListParams,
) {
  return useQuery<FindingListResponse>({
    queryKey: vulnerabilityFindingKeys.byVulnerability(vulnerabilityId),
    queryFn: () =>
      vulnerabilityFindingApi.listByVulnerability(vulnerabilityId, params),
    enabled: !!vulnerabilityId,
  });
}

// Hook to get findings for a specific system
export function useVulnerabilityFindingsBySystem(
  systemId: string,
  params?: FindingListParams,
) {
  return useQuery<FindingListResponse>({
    queryKey: vulnerabilityFindingKeys.bySystem(systemId),
    queryFn: () => vulnerabilityFindingApi.listBySystem(systemId, params),
    enabled: !!systemId,
  });
}

// Hook to get a single finding
export function useVulnerabilityFinding(id: string) {
  return useQuery({
    queryKey: vulnerabilityFindingKeys.detail(id),
    queryFn: () => vulnerabilityFindingApi.get(id),
    enabled: !!id,
  });
}

// Hook to mark finding as fixed
export function useMarkFindingFixed() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: MarkFindingFixedRequest }) =>
      vulnerabilityFindingApi.markFixed(id, data),
    onSuccess: (_, variables) => {
      // Invalidate all finding queries
      queryClient.invalidateQueries({
        queryKey: vulnerabilityFindingKeys.all,
      });
      // Also invalidate the specific finding
      queryClient.invalidateQueries({
        queryKey: vulnerabilityFindingKeys.detail(variables.id),
      });
    },
  });
}

// Hook to mark finding as verified
export function useMarkFindingVerified() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      id,
      data,
    }: {
      id: string;
      data: MarkFindingVerifiedRequest;
    }) => vulnerabilityFindingApi.markVerified(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: vulnerabilityFindingKeys.all,
      });
      queryClient.invalidateQueries({
        queryKey: vulnerabilityFindingKeys.detail(variables.id),
      });
    },
  });
}

// Hook to accept risk for a finding
export function useAcceptFindingRisk() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: AcceptRiskRequest }) =>
      vulnerabilityFindingApi.acceptRisk(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: vulnerabilityFindingKeys.all,
      });
      queryClient.invalidateQueries({
        queryKey: vulnerabilityFindingKeys.detail(variables.id),
      });
    },
  });
}
