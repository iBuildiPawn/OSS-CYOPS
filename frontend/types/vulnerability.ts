/**
 * TypeScript types for Vulnerability Management System
 * Generated from OpenAPI specification
 * Feature: 002-vulnerability-management
 */

export type VulnerabilitySeverity =
  | "CRITICAL"
  | "HIGH"
  | "MEDIUM"
  | "LOW"
  | "NONE";

export type VulnerabilityStatus =
  | "OPEN"
  | "IN_PROGRESS"
  | "RESOLVED"
  | "VERIFIED"
  | "CLOSED"
  | "FALSE_POSITIVE";

export type SystemType =
  | "SERVER"
  | "WORKSTATION"
  | "NETWORK_DEVICE"
  | "APPLICATION"
  | "CONTAINER"
  | "CLOUD_SERVICE"
  | "OTHER";

export type Environment = "PRODUCTION" | "STAGING" | "DEVELOPMENT" | "TEST";

export interface Vulnerability {
  id: string;
  title: string;
  description: string;
  severity: VulnerabilitySeverity;
  cvss_score?: number | null;
  cvss_vector?: string | null;
  cve_id?: string | null;
  status: VulnerabilityStatus;
  source: string;
  discovery_date: string; // ISO date format
  remediation_notes?: string | null;
  impact_assessment?: string | null;
  steps_to_reproduce?: string | null;
  mitigation_recommendations?: string | null;
  created_by_id: string;
  assigned_to_id?: string | null;
  created_at: string; // ISO datetime format
  updated_at: string; // ISO datetime format
}

export interface VulnerabilityDetail extends Vulnerability {
  created_by?: User;
  assigned_to?: User;
  affected_systems?: AffectedSystem[];
  status_history?: StatusHistoryEntry[];
}

export interface CreateVulnerabilityRequest {
  title: string;
  description: string;
  severity: VulnerabilitySeverity;
  cvss_score?: number;
  cvss_vector?: string;
  cve_id?: string;
  source?: string;
  discovery_date: string; // ISO date format
  impact_assessment?: string;
  steps_to_reproduce?: string;
  mitigation_recommendations?: string;
  assigned_to_id?: string;
  affected_system_ids: string[];
  new_affected_systems?: NewAffectedSystemData[];
}

export interface NewAffectedSystemData {
  hostname: string;
  ip_address: string;
  system_type: SystemType;
  environment: Environment;
}

export interface CreateVulnerabilityResponse {
  data: VulnerabilityDetail;
  auto_created_assets?: AutoCreatedAsset[];
}

export interface AutoCreatedAsset {
  id: string;
  hostname: string;
  ip_address: string;
}

export interface UpdateVulnerabilityRequest {
  title?: string;
  description?: string;
  severity?: VulnerabilitySeverity;
  cvss_score?: number;
  cvss_vector?: string;
  cve_id?: string;
  remediation_notes?: string;
  impact_assessment?: string;
  steps_to_reproduce?: string;
  mitigation_recommendations?: string;
}

export interface UpdateStatusRequest {
  status: VulnerabilityStatus;
  notes?: string;
}

export interface AssignVulnerabilityRequest {
  assigned_to_id: string | null;
}

export interface AffectedSystem {
  id: string;
  name: string;
  type: string;
  version?: string;
  environment?: string;
  description?: string;
  ip_address?: string;
  hostname?: string;
  owner?: string;
  created_at: string;
  updated_at: string;
}

export interface CreateAffectedSystemRequest {
  name: string;
  type: string;
  version?: string;
  environment?: string;
  description?: string;
  ip_address?: string;
  hostname?: string;
  owner?: string;
}

export interface UpdateAffectedSystemRequest {
  name?: string;
  type?: string;
  version?: string;
  environment?: string;
  description?: string;
  ip_address?: string;
  hostname?: string;
  owner?: string;
}

export interface AffectedSystemListParams {
  page?: number;
  limit?: number;
  type?: string;
  environment?: string;
  search?: string;
}

export interface AddAffectedSystemsRequest {
  system_ids: string[];
}

export interface User {
  id: string;
  email: string;
  name?: string;
}

export interface StatusHistoryEntry {
  id: string;
  old_status: VulnerabilityStatus;
  new_status: VulnerabilityStatus;
  notes?: string;
  changed_by?: User;
  changed_at: string;
}

export interface VulnerabilityListParams {
  page?: number;
  limit?: number;
  severity?: string; // Comma-separated severity values
  status?: string; // Comma-separated status values
  search?: string;
  assignedTo?: string;
  createdBy?: string;
  asset_id?: string; // Filter by affected system/asset
  discoveryDateFrom?: string;
  discoveryDateTo?: string;
  sortBy?: "discovery_date" | "severity" | "created_at" | "updated_at";
  sortOrder?: "asc" | "desc";
}

export interface PaginationMeta {
  page: number;
  limit: number;
  total: number;
  total_pages: number;
}

export interface VulnerabilityListResponse {
  data: Vulnerability[];
  meta: PaginationMeta;
}

export interface VulnerabilityResponse {
  data: Vulnerability;
}

export interface VulnerabilityDetailResponse {
  data: VulnerabilityDetail;
}

export interface AffectedSystemListResponse {
  data: AffectedSystem[];
  meta: PaginationMeta;
}

export interface VulnerabilityStats {
  total_count: number;
  by_severity: {
    critical: number;
    high: number;
    medium: number;
    low: number;
    none: number;
  };
  by_status: {
    open: number;
    in_progress: number;
    resolved: number;
    verified: number;
    closed: number;
    false_positive: number;
  };
  recent_discoveries: number;
  unassigned_count: number;
  critical_unresolved: number;
}

export interface ApiError {
  error: string;
  message: string;
  details?: Record<string, unknown>;
}

// Utility type for form data
export type VulnerabilityFormData = CreateVulnerabilityRequest;

// Utility type for filter options
export interface VulnerabilityFilters {
  severities: VulnerabilitySeverity[];
  statuses: VulnerabilityStatus[];
  assignedToId?: string;
  createdById?: string;
  dateRange?: {
    from: Date;
    to: Date;
  };
  searchQuery?: string;
}

// Severity display configuration
export const SEVERITY_CONFIG: Record<
  VulnerabilitySeverity,
  { label: string; color: string; priority: number }
> = {
  CRITICAL: { label: "Critical", color: "red", priority: 5 },
  HIGH: { label: "High", color: "orange", priority: 4 },
  MEDIUM: { label: "Medium", color: "yellow", priority: 3 },
  LOW: { label: "Low", color: "blue", priority: 2 },
  NONE: { label: "None", color: "gray", priority: 1 },
};

import {
  CheckCircle2,
  Circle,
  Clock,
  type LucideIcon,
  XCircle,
} from "lucide-react";

// Status display configuration
export const STATUS_CONFIG: Record<
  VulnerabilityStatus,
  { label: string; color: string; icon: LucideIcon }
> = {
  OPEN: { label: "Open", color: "red", icon: Circle },
  IN_PROGRESS: { label: "In Progress", color: "blue", icon: Clock },
  RESOLVED: { label: "Resolved", color: "yellow", icon: CheckCircle2 },
  VERIFIED: { label: "Verified", color: "green", icon: CheckCircle2 },
  CLOSED: { label: "Closed", color: "gray", icon: CheckCircle2 },
  FALSE_POSITIVE: { label: "False Positive", color: "purple", icon: XCircle },
};

// Valid status transitions
export const STATUS_TRANSITIONS: Record<
  VulnerabilityStatus,
  VulnerabilityStatus[]
> = {
  OPEN: ["IN_PROGRESS", "FALSE_POSITIVE"],
  IN_PROGRESS: ["RESOLVED", "FALSE_POSITIVE", "OPEN"],
  RESOLVED: ["VERIFIED", "IN_PROGRESS"],
  VERIFIED: ["CLOSED", "IN_PROGRESS"],
  CLOSED: [],
  FALSE_POSITIVE: ["OPEN"],
};

// Helper function to check if status transition is valid
export function isValidStatusTransition(
  from: VulnerabilityStatus,
  to: VulnerabilityStatus,
): boolean {
  return STATUS_TRANSITIONS[from].includes(to);
}

// Helper function to format CVSS score
export function formatCVSSScore(score?: number | null): string {
  if (!score) return "N/A";
  return score.toFixed(1);
}

// Helper function to get severity from CVSS score
export function getSeverityFromCVSS(score: number): VulnerabilitySeverity {
  if (score === 0) return "NONE";
  if (score < 4.0) return "LOW";
  if (score < 7.0) return "MEDIUM";
  if (score < 9.0) return "HIGH";
  return "CRITICAL";
}

// Helper function to validate CVE ID format
export function isValidCVEId(cveId: string): boolean {
  return /^CVE-[0-9]{4}-[0-9]{4,}$/.test(cveId);
}

// ============================================
// Vulnerability Finding Types (Feature 003)
// ============================================

export type FindingStatus =
  | "OPEN"
  | "IN_PROGRESS"
  | "MITIGATED"
  | "FIXED"
  | "VERIFIED"
  | "RISK_ACCEPTED"
  | "FALSE_POSITIVE";

export interface VulnerabilityFinding {
  id: string;
  vulnerability_id: string;
  vulnerability?: Vulnerability;
  affected_system_id: string;
  affected_system?: AffectedSystem;
  port: string;
  protocol: string;
  service_name: string;
  plugin_id: string;
  plugin_output?: string;
  scanner_name: string;
  status: FindingStatus;
  first_detected: string; // ISO datetime
  last_seen: string; // ISO datetime
  fixed_at?: string | null; // ISO datetime
  verified_at?: string | null; // ISO datetime
  fixed_by?: string | null;
  fix_notes?: string;
  risk_accepted_by?: string | null;
  risk_accepted_at?: string | null;
  acceptance_reason?: string;
  expires_at?: string | null; // For risk acceptance expiration
  created_by: string;
  created_at: string; // ISO datetime
  updated_at: string; // ISO datetime
}

export interface FindingListParams {
  page?: number;
  limit?: number;
  vulnerability_id?: string;
  affected_system_id?: string;
  status?: string; // Comma-separated status values
  scanner_name?: string;
  port?: string;
  protocol?: string;
  sortBy?: "first_detected" | "last_seen" | "status";
  sortOrder?: "asc" | "desc";
}

export interface FindingListResponse {
  data: VulnerabilityFinding[];
  meta: PaginationMeta;
}

export interface FindingDetailResponse {
  data: VulnerabilityFinding;
}

export interface MarkFindingFixedRequest {
  notes?: string;
}

export interface MarkFindingVerifiedRequest {
  notes?: string;
}

export interface AcceptRiskRequest {
  reason: string;
  expires_at?: string; // ISO datetime for risk acceptance expiration
}

// Finding status display configuration
export const FINDING_STATUS_CONFIG: Record<
  FindingStatus,
  { label: string; color: string; icon: LucideIcon }
> = {
  OPEN: { label: "Open", color: "red", icon: Circle },
  IN_PROGRESS: { label: "In Progress", color: "blue", icon: Clock },
  MITIGATED: { label: "Mitigated", color: "yellow", icon: CheckCircle2 },
  FIXED: { label: "Fixed", color: "green", icon: CheckCircle2 },
  VERIFIED: { label: "Verified", color: "green", icon: CheckCircle2 },
  RISK_ACCEPTED: { label: "Risk Accepted", color: "orange", icon: XCircle },
  FALSE_POSITIVE: { label: "False Positive", color: "purple", icon: XCircle },
};
