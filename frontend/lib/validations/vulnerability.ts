import { z } from "zod";
import { isValidCVEId } from "@/types/vulnerability";

// Vulnerability severity enum
export const vulnerabilitySeveritySchema = z.enum([
  "CRITICAL",
  "HIGH",
  "MEDIUM",
  "LOW",
  "NONE",
]);

// Vulnerability status enum
export const vulnerabilityStatusSchema = z.enum([
  "OPEN",
  "IN_PROGRESS",
  "RESOLVED",
  "VERIFIED",
  "CLOSED",
  "FALSE_POSITIVE",
]);

// System type enum
export const systemTypeSchema = z.enum([
  "SERVER",
  "WORKSTATION",
  "NETWORK_DEVICE",
  "APPLICATION",
  "CONTAINER",
  "CLOUD_SERVICE",
  "OTHER",
]);

// Environment enum
export const environmentSchema = z.enum([
  "PRODUCTION",
  "STAGING",
  "DEVELOPMENT",
  "TEST",
]);

// Create vulnerability validation schema
export const createVulnerabilitySchema = z.object({
  title: z
    .string()
    .min(1, "Title is required")
    .max(255, "Title must be less than 255 characters")
    .trim(),
  description: z
    .string()
    .min(1, "Description is required")
    .max(10000, "Description must be less than 10,000 characters")
    .trim(),
  severity: vulnerabilitySeveritySchema,
  cvss_score: z
    .number()
    .min(0, "CVSS score must be between 0.0 and 10.0")
    .max(10, "CVSS score must be between 0.0 and 10.0")
    .optional(),
  cvss_vector: z
    .string()
    .max(100, "CVSS vector must be less than 100 characters")
    .optional(),
  cve_id: z
    .string()
    .max(20, "CVE ID must be less than 20 characters")
    .refine(
      (val) => !val || isValidCVEId(val),
      "CVE ID must be in format CVE-YYYY-NNNNN",
    )
    .optional(),
  discovery_date: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Discovery date must be in format YYYY-MM-DD")
    .refine((date) => {
      const parsedDate = new Date(date);
      const today = new Date();
      today.setHours(23, 59, 59, 999); // End of today
      return parsedDate <= today;
    }, "Discovery date cannot be in the future"),
  impact_assessment: z
    .string()
    .max(10000, "Impact assessment must be less than 10,000 characters")
    .optional(),
  steps_to_reproduce: z
    .string()
    .max(10000, "Steps to reproduce must be less than 10,000 characters")
    .optional(),
  mitigation_recommendations: z
    .string()
    .max(
      10000,
      "Mitigation recommendations must be less than 10,000 characters",
    )
    .optional(),
  assigned_to_id: z.string().uuid("Invalid user ID").optional(),
  affected_system_ids: z
    .array(z.string().uuid("Invalid system ID"))
    .min(1, "At least one affected asset is required"),
});

export type CreateVulnerabilityFormData = z.infer<
  typeof createVulnerabilitySchema
>;

// Update vulnerability validation schema (all fields optional except what's being updated)
export const updateVulnerabilitySchema = z.object({
  title: z
    .string()
    .min(1, "Title is required")
    .max(255, "Title must be less than 255 characters")
    .trim()
    .optional(),
  description: z
    .string()
    .min(1, "Description is required")
    .max(10000, "Description must be less than 10,000 characters")
    .trim()
    .optional(),
  severity: vulnerabilitySeveritySchema.optional(),
  cvss_score: z
    .number()
    .min(0, "CVSS score must be between 0.0 and 10.0")
    .max(10, "CVSS score must be between 0.0 and 10.0")
    .optional()
    .nullable(),
  cvss_vector: z
    .string()
    .max(100, "CVSS vector must be less than 100 characters")
    .optional()
    .nullable(),
  cve_id: z
    .string()
    .max(20, "CVE ID must be less than 20 characters")
    .refine(
      (val) => !val || isValidCVEId(val),
      "CVE ID must be in format CVE-YYYY-NNNNN",
    )
    .optional()
    .nullable(),
  remediation_notes: z
    .string()
    .max(10000, "Remediation notes must be less than 10,000 characters")
    .optional()
    .nullable(),
  impact_assessment: z
    .string()
    .max(10000, "Impact assessment must be less than 10,000 characters")
    .optional()
    .nullable(),
  steps_to_reproduce: z
    .string()
    .max(10000, "Steps to reproduce must be less than 10,000 characters")
    .optional()
    .nullable(),
  mitigation_recommendations: z
    .string()
    .max(
      10000,
      "Mitigation recommendations must be less than 10,000 characters",
    )
    .optional()
    .nullable(),
});

export type UpdateVulnerabilityFormData = z.infer<
  typeof updateVulnerabilitySchema
>;

// Update status validation schema
export const updateStatusSchema = z.object({
  status: vulnerabilityStatusSchema,
  notes: z
    .string()
    .max(5000, "Notes must be less than 5,000 characters")
    .optional()
    .nullable(),
});

export type UpdateStatusFormData = z.infer<typeof updateStatusSchema>;

// Assign vulnerability validation schema
export const assignVulnerabilitySchema = z.object({
  assigned_to_id: z.string().uuid("Invalid user ID").nullable(),
});

export type AssignVulnerabilityFormData = z.infer<
  typeof assignVulnerabilitySchema
>;

// Affected system validation schema
export const createAffectedSystemSchema = z
  .object({
    hostname: z
      .string()
      .max(255, "Hostname must be less than 255 characters")
      .optional()
      .nullable(),
    ip_address: z
      .string()
      .max(45, "IP address must be less than 45 characters")
      .regex(
        /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^::1$|^::$/,
        "Invalid IP address format (IPv4 or IPv6)",
      )
      .optional()
      .nullable(),
    asset_id: z
      .string()
      .max(100, "Asset ID must be less than 100 characters")
      .optional()
      .nullable(),
    system_type: systemTypeSchema,
    description: z
      .string()
      .max(1000, "Description must be less than 1,000 characters")
      .optional()
      .nullable(),
    environment: environmentSchema.default("PRODUCTION"),
  })
  .refine((data) => data.hostname || data.ip_address || data.asset_id, {
    message: "At least one of hostname, IP address, or asset ID is required",
    path: ["hostname"],
  });

export type CreateAffectedSystemFormData = z.infer<
  typeof createAffectedSystemSchema
>;

// Vulnerability filter validation schema
export const vulnerabilityFilterSchema = z.object({
  severity: z.string().optional(), // Comma-separated values
  status: z.string().optional(), // Comma-separated values
  search: z.string().max(255).optional(),
  assignedTo: z.string().uuid().optional(),
  createdBy: z.string().uuid().optional(),
  discoveryDateFrom: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/)
    .optional(),
  discoveryDateTo: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/)
    .optional(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(50),
  sortBy: z
    .enum(["discovery_date", "severity", "created_at", "updated_at"])
    .default("created_at"),
  sortOrder: z.enum(["asc", "desc"]).default("desc"),
});

export type VulnerabilityFilterFormData = z.infer<
  typeof vulnerabilityFilterSchema
>;

// CVSS calculator helpers
export const cvssMetricSchema = z.object({
  attackVector: z.enum(["N", "A", "L", "P"]), // Network, Adjacent, Local, Physical
  attackComplexity: z.enum(["L", "H"]), // Low, High
  privilegesRequired: z.enum(["N", "L", "H"]), // None, Low, High
  userInteraction: z.enum(["N", "R"]), // None, Required
  scope: z.enum(["U", "C"]), // Unchanged, Changed
  confidentiality: z.enum(["N", "L", "H"]), // None, Low, High
  integrity: z.enum(["N", "L", "H"]), // None, Low, High
  availability: z.enum(["N", "L", "H"]), // None, Low, High
});

export type CVSSMetrics = z.infer<typeof cvssMetricSchema>;

// Helper function to validate and format date
export const formatDateForInput = (dateString?: string | null): string => {
  if (!dateString) {
    const today = new Date();
    return today.toISOString().split("T")[0];
  }
  const date = new Date(dateString);
  return date.toISOString().split("T")[0];
};

// Helper function to validate CVE ID on input
export const validateCVEId = (cveId: string): boolean => {
  return /^CVE-\d{4}-\d{4,}$/.test(cveId);
};
